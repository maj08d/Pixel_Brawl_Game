using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using Microsoft.Xna.Framework.Input;
using System;
using System.Collections.Generic;

namespace Pixel_Brawl4
{
    public class Game1 : Game
    {
        private GraphicsDeviceManager _graphics;
        private SpriteBatch _spriteBatch;

        private Texture2D titleTexture; // Variable to store 

        private Texture2D levelselectmario;

        private Texture2D levelselectsonic;
        private Texture2D levelselectpacman;
        private Texture2D levelselectspaceinvader;

        private Texture2D levelselect1_3;

        private Texture2D marioSprite;
        private Texture2D sonicSprite;
        private Texture2D pacmanSprite;
        private Texture2D spaceInvaderSprite;

        private Texture2D goombaSprite;

        private bool inmariolevelselect = false;

        private bool insoniclevelselect = false;
        private bool inpacmanlevelselect = false;
        private bool inspaceinvaderlevelselect = false;
        private bool inlevelselect1_3 = false;
        private bool startup = true;

        Texture2D bulletTexture;
        List<Bullet> bullets = new List<Bullet>();

        Texture2D flagTexture;
        Vector2 flagPosition;
        Rectangle flagBounds;


        List<Villain> villains = new List<Villain>();

        // Player
        private Texture2D playerTexture;

        Vector2 playerPosition;

        Vector2 playerVelocity;

        Vector2 previousPlayerPosition;

        bool isOnGround;

        enum Character
        {
            None,
            Mario,
            Sonic,
            Pacman,
            SpaceInvader
        }

        Character selectedCharacter = Character.None;

        private void ReturnToLevelSelect()
        {
            inlevel1 = false;
            inlevelselect1_3 = true;

            villains.Clear();
            bullets.Clear();

            // Reset player
            playerVelocity = Vector2.Zero;
            playerPosition = new Vector2(50, 50);
            isOnGround = false;
        }






        // Camera
        Rectangle camera;

        // Tilemap
        Texture2D groundTile;

        int tileSize = 32;

        int[,] level1Tiles;

        private bool inlevel1 = false;

        List<Rectangle> platforms = new List<Rectangle>()
        {
         new Rectangle(0, 400, 800, 50),   
         new Rectangle(400, 250, 150, 20) 
        };

        // Buttons in ORIGINAL image pixels
        private Rectangle startButtonArea = new Rectangle(584, 649, 416, 100);

        private MouseState previousMouse;
        private KeyboardState previousKeyboard;

        public Game1()
        {
            _graphics = new GraphicsDeviceManager(this);
            Content.RootDirectory = "Content";
            IsMouseVisible = true;
        }

        protected override void LoadContent()
        {
            _spriteBatch = new SpriteBatch(GraphicsDevice);

            // Load image
            titleTexture = Content.Load<Texture2D>("TitlePage");
            levelselectmario = Content.Load<Texture2D>("levelselectmario");

            levelselectsonic = Content.Load<Texture2D>("levelselectsonic");
            levelselectpacman = Content.Load<Texture2D>("levelselectpacman");
            levelselectspaceinvader = Content.Load<Texture2D>("levelselectspaceinvader");
            levelselect1_3 = Content.Load<Texture2D>("levelselect1_3");

            _spriteBatch = new SpriteBatch(GraphicsDevice);

            // Characters
            marioSprite = Content.Load<Texture2D>("mariosprite");
            sonicSprite = Content.Load<Texture2D>("sonicsprite");
            pacmanSprite = Content.Load<Texture2D>("pacmansprite");
            spaceInvaderSprite = Content.Load<Texture2D>("spaceinvadersprite");

            // Tiles
            groundTile = Content.Load<Texture2D>("GroundTile");

            // Villains
            goombaSprite = Content.Load<Texture2D>("goombaSprite");

            // Bullet
            bulletTexture = Content.Load<Texture2D>("bullet");

            // Flag
            flagTexture = Content.Load<Texture2D>("flag");


            level1Tiles = new int[100, 20];

            // Fill bottom row with ground
            for (int x = 0; x < 20; x++)
                level1Tiles[x, 9] = 1;  // 1 = ground tile

            // Starting player position
            playerPosition = new Vector2(50, 50);
        }

        protected override void Update(GameTime gameTime)
        {
            if (GamePad.GetState(PlayerIndex.One).Buttons.Back == ButtonState.Pressed ||
                Keyboard.GetState().IsKeyDown(Keys.Escape))
                Exit();

            MouseState currentMouse = Mouse.GetState();
            KeyboardState currentKeyboard = Keyboard.GetState();

            // Mouse click logic
            if (currentMouse.LeftButton == ButtonState.Pressed && previousMouse.LeftButton == ButtonState.Released)
            {
                if (startup)
                {
                    // Title page start button
                    Rectangle scaledStartButton = ScaleRectangle(startButtonArea, titleTexture);
                    if (scaledStartButton.Contains(currentMouse.Position))
                    {
                        startup = false;
                        inmariolevelselect = true;
                    }
                }
            }
            if (inmariolevelselect && currentKeyboard.IsKeyDown(Keys.Enter) &&
                    previousKeyboard.IsKeyUp(Keys.Enter))
            {
                Console.WriteLine("Mario selected!");
                inlevelselect1_3 = true;
                inmariolevelselect = false;
                selectedCharacter = Character.Mario;
                playerTexture = marioSprite;
                // then starts Mario gameplay
            }


            // Keyboard input: right arrow to move to Sonic screen
            else if (inmariolevelselect &&
                currentKeyboard.IsKeyDown(Keys.Right) &&
                previousKeyboard.IsKeyUp(Keys.Right))
            {
                inmariolevelselect = false;
                insoniclevelselect = true;
            }

            else if (insoniclevelselect && currentKeyboard.IsKeyDown(Keys.Left) &&
                previousKeyboard.IsKeyUp(Keys.Left))
            {
                inmariolevelselect = true;
                insoniclevelselect = false;
            }

            else if (insoniclevelselect && currentKeyboard.IsKeyDown(Keys.Enter) &&
                previousKeyboard.IsKeyUp(Keys.Enter))
            {
                Console.WriteLine("Sonic selected!");
                inlevelselect1_3 = true;
                insoniclevelselect = false;
                selectedCharacter = Character.Sonic;
                playerTexture = sonicSprite;
                // TODO: start Sonic gameplay
            }

            else if (insoniclevelselect && currentKeyboard.IsKeyDown(Keys.Right) &&
                previousKeyboard.IsKeyUp(Keys.Right))
            {
                insoniclevelselect = false;
                inpacmanlevelselect = true;
            }

            else if (inpacmanlevelselect &&
                     currentKeyboard.IsKeyDown(Keys.Left) &&
                     previousKeyboard.IsKeyUp(Keys.Left))
            {
                inpacmanlevelselect = false;
                insoniclevelselect = true;
            }

            else if (inpacmanlevelselect && currentKeyboard.IsKeyDown(Keys.Enter) &&
                previousKeyboard.IsKeyUp(Keys.Enter))
            {
                Console.WriteLine("Pacman selected!");
                inlevelselect1_3 = true;
                inpacmanlevelselect = false;
                selectedCharacter = Character.Pacman;
                playerTexture = pacmanSprite;
                // TODO: start Pacman gameplay
            }

            else if (inpacmanlevelselect && currentKeyboard.IsKeyDown(Keys.Right) &&
                previousKeyboard.IsKeyUp(Keys.Right))

            {
                inpacmanlevelselect = false;
                inspaceinvaderlevelselect = true;
            }

            else if (inspaceinvaderlevelselect && currentKeyboard.IsKeyDown(Keys.Left) &&
                previousKeyboard.IsKeyUp(Keys.Left))

            {
                inpacmanlevelselect = true;
                inspaceinvaderlevelselect = false;
            }

            else if (inspaceinvaderlevelselect && currentKeyboard.IsKeyDown(Keys.Enter) &&
                previousKeyboard.IsKeyUp(Keys.Enter))
            {
                Console.WriteLine("Space Invader selected!");
                inlevelselect1_3 = true;
                inspaceinvaderlevelselect = false;
                selectedCharacter = Character.SpaceInvader;
                playerTexture = spaceInvaderSprite;
                // TODO: start Space Invader gameplay
            }



            // LEVEL 1 START (pressing "1")
            if (inlevelselect1_3 &&
                selectedCharacter != Character.None &&
                currentKeyboard.IsKeyDown(Keys.D1) &&
                previousKeyboard.IsKeyUp(Keys.D1))
            {
                inlevelselect1_3 = false;
                inlevel1 = true;

                // Load Villain
                int groundY = 400 - goombaSprite.Height;
                villains.Add(new Villain(goombaSprite, new Vector2(400, groundY)));

                // Ground Y
                groundY = 400 - flagTexture.Height;

                // Place flag at end of base platform
                flagPosition = new Vector2(800 - flagTexture.Width - 10, groundY);

                flagBounds = new Rectangle(
                    (int)flagPosition.X,
                    (int)flagPosition.Y,
                    flagTexture.Width,
                    flagTexture.Height
                );


            }


            if (inlevel1)
            {
                foreach (var v in villains)
                    v.Update(gameTime);
            }




            if (inlevel1)
            {
                if (Keyboard.GetState().IsKeyDown(Keys.Z) && previousKeyboard.IsKeyUp(Keys.Z))
                {
                    Vector2 bulletPosition = new Vector2(
                        playerPosition.X + playerTexture.Width,
                        playerPosition.Y + playerTexture.Height / 2
                    );

                    bullets.Add(new Bullet(
                        bulletTexture,
                        bulletPosition,
                        new Vector2(8f, 0f) // speed to the right
                    ));
                }

                for (int i = bullets.Count - 1; i >= 0; i--)
                {
                    bullets[i].Update();

                    // Remove bullet if it goes too far
                    if (bullets[i].Position.X > camera.X + 900)
                        bullets.RemoveAt(i);
                }

                for (int i = bullets.Count - 1; i >= 0; i--)
                {
                    for (int j = villains.Count - 1; j >= 0; j--)
                    {
                        if (bullets[i].Bounds.Intersects(villains[j].Bounds))
                        {
                            bullets.RemoveAt(i);
                            villains.RemoveAt(j);
                            break;
                        }
                    }
                }



                KeyboardState kb = Keyboard.GetState();

                // Horizontal movement
                if (kb.IsKeyDown(Keys.Left))
                    playerVelocity.X = -3;
                else if (kb.IsKeyDown(Keys.Right))
                    playerVelocity.X = 3;
                else
                    playerVelocity.X = 0;

                // Jump
                if (kb.IsKeyDown(Keys.Space) && isOnGround)
                {
                    playerVelocity.Y = -10;
                    isOnGround = false;
                }

                // Gravity
                playerVelocity.Y += 0.5f;

                previousPlayerPosition = playerPosition;

                // Update position
                playerPosition += playerVelocity;

                // Collision with platforms
                isOnGround = false;

                Rectangle playerRect = new Rectangle(
                    (int)playerPosition.X,
                    (int)playerPosition.Y,
                    playerTexture.Width,
                    playerTexture.Height
                );

                if (playerRect.Intersects(flagBounds))
                {
                    ReturnToLevelSelect();
                }


                foreach (var v in villains)
                {
                    if (playerRect.Intersects(v.Bounds))
                    {
                        ReturnToLevelSelect();
                        break;
                    }
                }



                foreach (var platform in platforms)
                {
                    if (playerRect.Intersects(platform))
                    {
                        if (playerVelocity.Y > 0 &&
                            (playerRect.Bottom - (int)playerVelocity.Y) <= platform.Top)
                        {
                            playerPosition.Y = platform.Top - playerTexture.Height;
                            playerVelocity.Y = 0;
                            isOnGround = true;

                            playerRect = new Rectangle(
                                (int)playerPosition.X,
                                (int)playerPosition.Y,
                                playerTexture.Width,
                                playerTexture.Height
                            );
                        }
                    }
                }

                camera = new Rectangle(
                    (int)playerPosition.X - 400, // follow player horizontally
                     0,                           // LOCK Y
                     800,
                     600
                );

                // Clamp camera so it doesn't go outside the world
                camera.X = MathHelper.Clamp(
                    camera.X,
                    0,
                    level1Tiles.GetLength(0) * tileSize - camera.Width
                );


            }

            previousMouse = currentMouse;
            previousKeyboard = currentKeyboard;
            // base.Update should ALWAYS be outside inlevel1
            base.Update(gameTime);
        }

        protected override void Draw(GameTime gameTime)
        {
            GraphicsDevice.Clear(Color.LightBlue);

            _spriteBatch.Begin();

            if (startup)
            {
                _spriteBatch.Draw(titleTexture,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);
            }
            else if (inmariolevelselect)
            {
                _spriteBatch.Draw(levelselectmario,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);
            }
            else if (insoniclevelselect)
            {
                _spriteBatch.Draw(levelselectsonic,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);
            }
            else if (inpacmanlevelselect)
            {
                _spriteBatch.Draw(levelselectpacman,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);
            }

            else if (inspaceinvaderlevelselect)
            {
                _spriteBatch.Draw(levelselectspaceinvader,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);

            }
            else if (inlevelselect1_3)
                _spriteBatch.Draw(levelselect1_3,
                    new Rectangle(0, 0, GraphicsDevice.Viewport.Width, GraphicsDevice.Viewport.Height),
                    Color.White);

            if (inlevel1)
            {
                // Draw tiles
                for (int x = 0; x < level1Tiles.GetLength(0); x++)
                {
                    for (int y = 0; y < level1Tiles.GetLength(1); y++)
                    {
                        if (level1Tiles[x, y] == 1)
                        {
                            _spriteBatch.Draw(
                                groundTile,
                                new Vector2(x * tileSize - camera.X, y * tileSize - camera.Y),
                                Color.White
                            );
                        }
                    }
                }

                // Draw platforms
                foreach (var platform in platforms)
                {
                    _spriteBatch.Draw(
                        groundTile,
                        new Rectangle(platform.X - camera.X, platform.Y - camera.Y, platform.Width, platform.Height),
                        Color.White
                    );
                }

                foreach (var bullet in bullets)
                {
                    bullet.Draw(_spriteBatch, new Vector2(camera.X, camera.Y));
                }


                // Choose character sprite
                Texture2D playerSprite = null;

                if (selectedCharacter == Character.Mario)
                    playerSprite = marioSprite;
                else if (selectedCharacter == Character.Sonic)
                    playerSprite = sonicSprite;
                else if (selectedCharacter == Character.Pacman)
                    playerSprite = pacmanSprite;
                else if (selectedCharacter == Character.SpaceInvader)
                    playerSprite = spaceInvaderSprite;

                // Draw player
                _spriteBatch.Draw(
                    playerSprite,
                    playerPosition - new Vector2(camera.X, camera.Y),
                    Color.White
                );

                if (inlevel1)
                {
                    foreach (var v in villains)
                        v.Draw(_spriteBatch, new Vector2(camera.X, camera.Y));

                    _spriteBatch.Draw(
                        flagTexture, flagPosition - new Vector2(camera.X, camera.Y), Color.White);
                }


            }

            _spriteBatch.End();
            base.Draw(gameTime);
        }

        /// <summary>
        /// Scale a rectangle from original image pixels to the current viewport size
        /// </summary>
        private Rectangle ScaleRectangle(Rectangle original, Texture2D texture)
        {
            float scaleX = (float)GraphicsDevice.Viewport.Width / texture.Width;
            float scaleY = (float)GraphicsDevice.Viewport.Height / texture.Height;

            return new Rectangle(
                (int)(original.X * scaleX),
                (int)(original.Y * scaleY),
                (int)(original.Width * scaleX),
                (int)(original.Height * scaleY)
            );
        }
    }
}

